<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Desafio dos Enigmas — Procedural</title>
<style>
  :root{--bg:#071029;--card:#0b1630;--accent:#60a5fa;--ok:#10b981;--danger:#f43f5e;--text:#e6eef8}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#021026 0%,#061228 100%);color:var(--text);font-family:Inter,system-ui,Arial;padding:18px;display:flex;align-items:center;justify-content:center}
  .wrap{width:100%;max-width:980px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.6)}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .tiny{color:#93b3df;font-size:13px}
  .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
  select,input,button{padding:8px;border-radius:8px;border:none}
  button{background:var(--accent);color:#021124;font-weight:700;cursor:pointer}
  .content{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:16px}
  .left{padding:12px;background:rgba(255,255,255,0.02);border-radius:10px}
  .right{padding:12px;background:rgba(255,255,255,0.01);border-radius:10px}
  .level-box{padding:12px;border-radius:10px;background:rgba(255,255,255,0.015);margin-bottom:10px}
  .input-row{display:flex;gap:8px;margin-top:12px}
  .hint{margin-top:8px;color:#bcd7ff}
  .status{margin-top:10px;font-size:13px}
  .meter{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:8px}
  .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#9be7ff);width:0%}
  .small{font-size:13px;color:#9fb6df}
  .code{background:#071328;padding:8px;border-radius:8px;font-family:monospace}
  canvas{width:100%;border-radius:8px;background:#071328;display:block}
  footer{margin-top:12px;text-align:center;color:#93b3df;font-size:13px}
  @media(max-width:900px){.content{grid-template-columns:1fr}.right{order:2}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Desafio dos Enigmas</h1>
      <div class="tiny">Escolha dificuldade. Nível impossível sem dicas.</div>
      <div class="controls">
        <label class="small">Dificuldade</label>
        <select id="difficulty"><option value="easy">Fácil</option><option value="medium">Médio</option><option value="hard">Difícil</option><option value="impossible">Impossível</option></select>
        <button id="startBtn">Começar</button>
      </div>
    </header>

    <div class="content">
      <section class="left">
        <div id="levelArea"></div>
        <div class="level-box">
          <div class="small">Resposta</div>
          <div class="input-row">
            <input id="answerInput" placeholder="Digite sua resposta aqui">
            <button id="submitBtn">Enviar</button>
          </div>
          <div class="hint" id="hintArea">Dica: disponível conforme a dificuldade (ou não).</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="hintBtn" style="background:#ffb86b;color:#021124">Pedir dica</button>
            <button id="skipBtn" style="background:#ef4444;color:white">Pular (perde pontos)</button>
          </div>
          <div class="status" id="status"></div>
        </div>
      </section>

      <aside class="right">
        <div class="right-panel">
          <div class="small">Progresso</div>
          <div class="meter"><i id="meter"></i></div>
          <div class="small" id="progressText">0 / 0</div>
          <div style="margin-top:12px" class="small">Tentativas restantes: <span id="tries">-</span></div>
          <div style="margin-top:12px" class="small">Pontuação: <strong id="score">0</strong></div>
          <div style="margin-top:12px">
            <div class="small">Timer</div>
            <div class="code" id="timer">00:00</div>
          </div>
          <div style="margin-top:12px">
            <div class="small">Mapa de níveis</div>
            <div id="mapArea" class="small"></div>
          </div>
        </div>
      </aside>
    </div>

    <footer id="footer">Nível impossível foi projetado para NÃO ser resolvido por meios lógicos simples.</footer>
  </div>
</div>

<script>
// Procedural generation of levels based on difficulty
// Difficulty affects count, complexity, hints availability and whether unsolvable appears

function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

// small generators
function genRiddle(){
  const items = [
    {q:'Sou alto quando sou jovem e curto quando sou velho. O que sou?', a:'vela', h:'Algo que derrete.'},
    {q:'O que tem chaves mas não abre portas?', a:'piano', h:'Instrumento.'},
    {q:'Tem cidades, mas não casas; florestas, mas não árvores; e água, mas não peixes. O que é?', a:'mapa', h:'Você usa para se orientar.'}
  ]
  return pick(items)
}

function genPrimeQuestion(){
  const primes = [2,3,5,7,11,13,17,19,23,29,31]
  const idx = randInt(0,primes.length-3)
  const seq = primes.slice(idx, idx+5)
  return { q:`Encontre o próximo: ${seq.join(', ')} , ?`, a:String(primes[idx+5]), h:'Sequência de números primos.' }
}

function genCaesarCipher(){
  const words = ['HELLO','SECRET','PUZZLE','QUEST']
  const w = pick(words)
  const shift = randInt(1,25)
  const enc = caesarEncode(w, shift)
  return { q:enc, a:w, h:'Cifra de César. Tente deslocar letras.' }
}

function genMath(){
  const a=randInt(2,12), b=randInt(2,12)
  return { q:`Quanto é ${a} × ${b}?`, a:String(a*b), h:'Multiplicação simples.' }
}

function genStringPuzzle(){
  const base = 'a1b2c3d4'
  return { q:`Qual a palavra: ${base} (pegue caracteres nas posições ímpares)`, a:base.split('').filter((_,i)=>i%2===0).join(''), h:'Use índice 1,3,5...' }
}

function genCanvasCount(){
  // returns an object with draw() and answer
  const circles = randInt(4,9)
  return { q:'Conte quantos círculos aparecem na imagem.', draw:(ctx)=>{
      ctx.fillStyle='#071328'; ctx.fillRect(0,0,600,200);
      for(let i=0;i<circles;i++){ ctx.beginPath(); ctx.fillStyle=['#ffd6a5','#a6e3a1','#9bd3ff'][i%3]; ctx.arc(60+ (i*60)%540, 40 + ((i*30)%120), 12 + (i%3)*8,0,Math.PI*2); ctx.fill() }
    }, a:String(circles), h:'Conte pequenas e grandes.' }
}

// Caesar helpers
function caesarEncode(str, shift){ return str.split('').map(ch=>{ const A='A'.charCodeAt(0), a='a'.charCodeAt(0); const code=ch.charCodeAt(0); if(code>=65 && code<=90) return String.fromCharCode((code-65+shift)%26+65); if(code>=97 && code<=122) return String.fromCharCode((code-97+shift)%26+97); return ch }).join('') }
function caesarDecode(str, shift){ return caesarEncode(str, 26-shift) }

// Generate levels
function generateLevels(difficulty){
  const levels = []
  let count = 5
  if(difficulty==='easy') count = 5
  if(difficulty==='medium') count = 7
  if(difficulty==='hard') count = 9
  if(difficulty==='impossible') count = 6 // includes one impossible level

  for(let i=0;i<count;i++){
    const r = randInt(1,6)
    let obj=null
    if(r<=2) obj = genRiddle()
    else if(r===3) obj = genPrimeQuestion()
    else if(r===4) obj = genCaesarCipher()
    else if(r===5) obj = genMath()
    else obj = genStringPuzzle()

    // sometimes include canvas
    if(Math.random()<0.15) obj = genCanvasCount()

    levels.push({ id:i+1, title:`Porta ${i+1}`, type: obj.draw? 'canvas' : (obj.a.match(/^\d+$/)? 'math' : (obj.q.length>20 && /[A-Z]{2,}/.test(obj.q)? 'cipher' : 'text')), question: obj.q, answer: obj.a, hint: obj.h, attempts: difficulty==='hard'?3: difficulty==='impossible'?1:5, hintCost: difficulty==='easy'?3: difficulty==='medium'?6:10, skipCost: difficulty==='easy'?6: difficulty==='medium'?12:20 })
  }

  // If impossible difficulty: append one truly impossible puzzle (random long hash, no hint, no tries)
  if(difficulty==='impossible'){
    const impossible = { id: levels.length+1, title:'Porta Final', type:'impossible', question:'Resolva o enigma final: ' + btoa(cryptoRandomString(48)).slice(0,40), answer: cryptoRandomString(64), hint:'—', attempts:0, hintCost:9999, skipCost:9999 }
    levels.push(impossible)
  }

  return levels
}

function cryptoRandomString(len){ const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s=''; for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)]; return s }

// Game state
let LEVELS = []
let state = { index:0, triesLeft:5, score:100, startTime:null, solved:[] }
const $ = id => document.getElementById(id)

function startGame(){
  const diff = $('difficulty').value
  LEVELS = generateLevels(diff)
  state = { index:0, triesLeft: LEVELS[0].attempts, score:100, startTime: Date.now(), solved: Array(LEVELS.length).fill(false), difficulty:diff }
  if(diff==='impossible') $('hintBtn').disabled = true
  else $('hintBtn').disabled = false
  renderLevel(); startTimer(); updateProgress()
}

function renderLevel(){
  const lvl = LEVELS[state.index]
  // build UI
  let html = `<div class=\"level-box\"><div class=\"small\">${lvl.title}</div><h2>${lvl.question}</h2><div class=\"small\">Tipo: ${lvl.type}</div></div>`
  $('levelArea').innerHTML = html
  if(lvl.type==='canvas') drawCanvasDynamic(lvl)
  $('tries').textContent = lvl.attempts>0? state.triesLeft : '—'
  $('status').textContent = ''
  $('answerInput').value = ''
  $('hintArea').textContent = 'Dica: ' + (lvl.hint || (lvl.type==='impossible'? 'Nenhuma dica disponível.':'Disponível'))
}

function drawCanvasDynamic(lvl){ removeCanvasIfExists(); const container = document.createElement('div'); const cv = document.createElement('canvas'); cv.width=600; cv.height=200; container.appendChild(cv); container.className='draw-canvas'; $('levelArea').appendChild(container); const ctx = cv.getContext('2d'); lvl.draw(ctx) }
function removeCanvasIfExists(){ const c = document.querySelector('.draw-canvas'); if(c) c.remove() }

function updateProgress(){ const solvedCount = state.solved.filter(Boolean).length; const total = LEVELS.length; const pct = Math.round((solvedCount/total)*100); $('meter').style.width = pct + '%'; $('progressText').textContent = solvedCount + ' / ' + total; $('score').textContent = state.score; $('mapArea').innerHTML = LEVELS.map((l,i)=> state.solved[i] ? '●' : (i===state.index ? '▶' : '○')).join(' ') }

// Timer
let timerInterval = null
function startTimer(){ if(timerInterval) clearInterval(timerInterval); state.startTime = Date.now(); timerInterval = setInterval(()=>{ const s = Math.floor((Date.now()-state.startTime)/1000); const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); $('timer').textContent = mm + ':' + ss; },500) }

// Answer check
function normalize(a){ return String(a).trim().toLowerCase().replace(/[^a-z0-9\s]/g,'') }

$('submitBtn').addEventListener('click', ()=>{
  const lvl = LEVELS[state.index]
  const attempt = $('answerInput').value
  if(!attempt){ $('status').textContent = 'Digite uma resposta.'; return }

  let ok = false
  if(lvl.type==='cipher'){
    // try to decode user's input OR accept decoded of displayed
    const inp = attempt.trim()
    for(let k=0;k<26;k++){ if(caesarDecode(inp,k).toLowerCase() === lvl.answer.toLowerCase()) ok=true }
    // also accept if user decodes displayed cipher
    for(let k=0;k<26;k++){ if(caesarDecode(lvl.question,k).toLowerCase() === inp.toLowerCase()) ok=true }
  } else if(lvl.type==='impossible'){
    // impossible level: never accept (unless exact match of hidden random which user can't deduce)
    ok = attempt === lvl.answer
  } else {
    ok = normalize(attempt) === normalize(lvl.answer)
  }

  if(ok){ state.solved[state.index] = true; state.score += 20; $('status').innerHTML = `<div class='success'>Porta aberta! Você passou pelo nível ${state.index+1}.</div>`; setTimeout(()=> nextLevel(),700) }
  else {
    if(lvl.attempts>0){ state.triesLeft -=1; state.score -=5; $('status').textContent = 'Resposta errada.'; if(state.triesLeft<=0) $('status').textContent = 'Sem tentativas. Use pular.' }
    else { $('status').textContent = 'Este nível não aceita tentativas.' }
  }
  updateProgress()
})

$('hintBtn').addEventListener('click', ()=>{
  const lvl = LEVELS[state.index]
  if(state.difficulty==='impossible'){ alert('Dicas não estão disponíveis no modo impossível.'); return }
  if(state.score < lvl.hintCost){ alert('Pontos insuficientes para dica.'); return }
  state.score -= lvl.hintCost
  $('hintArea').textContent = 'Dica: ' + (lvl.hint || 'Sem dica')
  updateProgress()
})

$('skipBtn').addEventListener('click', ()=>{
  const lvl = LEVELS[state.index]
  if(!confirm('Pular nível? Isso reduzirá ' + (lvl.skipCost||10) + ' pontos.')) return
  state.score -= (lvl.skipCost||10)
  state.solved[state.index] = true
  updateProgress(); nextLevel()
})

function nextLevel(){ if(state.index < LEVELS.length-1){ state.index +=1; state.triesLeft = LEVELS[state.index].attempts; renderLevel() } else finishGame() }
function finishGame(){ $('levelArea').innerHTML = `<div class='level-box'><h2>Parabéns — você completou os enigmas!</h2><div class='small'>Pontuação final: <strong>${state.score}</strong></div></div>`; removeCanvasIfExists(); updateProgress(); clearInterval(timerInterval) }

// allow enter
$('answerInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('submitBtn').click() })

// init: start on easy by default when pressing start
$('startBtn').addEventListener('click', startGame)

</script>
</body>
</html>
